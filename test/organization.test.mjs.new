import { test, describe } from 'node:test';
import assert from 'node:assert';
import organizationModule from '../models/organization.mjs';
import userModule from '../models/user.mjs';
import roleModule from '../models/role.mjs';

const {
    createOrganization,
    getAllOrganizations,
    getOrganization,
    getOrganizationEvents,
    addUserToOrganization,
    getOrganizationUsers
} = organizationModule;

describe('Organization Management Tests', async () => {
    // Setup: Create test user and get owner role
    const timestamp = Date.now();
    const userId = await userModule.createUser(
        `Test User ${timestamp}`,
        `test${timestamp}@example.com`,
        'password123'
    );
    const testUser = await userModule.getUser(userId);
    assert.ok(testUser, 'Test user should be created');
    
    const ownerRole = await roleModule.getOwnerRole();
    assert.ok(ownerRole, 'Owner role should exist');

    test('createOrganization should create a new organization', async () => {
        const orgName = 'Test Organization';
        const orgIcon = 'test-icon.png';
        const orgDesc = 'Test Description';
        
        const orgId = await createOrganization(orgName, orgIcon, orgDesc, testUser.id);
        assert.ok(orgId, 'Organization ID should be returned');
        assert.strictEqual(typeof orgId, 'number');
        
        const org = await getOrganization(orgId);
        assert.ok(org, 'Organization should be retrievable');
        assert.strictEqual(org.name, orgName);
        assert.strictEqual(org.icon, orgIcon);
        assert.strictEqual(org.description, orgDesc);
    });

    test('getAllOrganizations should return array of organizations', async () => {
        const orgs = await getAllOrganizations();
        assert.strictEqual(Array.isArray(orgs), true);
        assert.strictEqual(orgs.length >= 1, true, 'Should have at least one organization');
        
        const org = orgs[0];
        assert.ok(org.id);
        assert.ok(org.name);
        assert.ok('description' in org);
        assert.ok('icon' in org);
    });

    test('getOrganization should return null for non-existent organization', async () => {
        const nonExistentId = 99999;
        const org = await getOrganization(nonExistentId);
        assert.strictEqual(org, null);
    });

    test('getOrganizationEvents should return empty array for new organization', async () => {
        const orgName1 = 'Test Org Events';
        const orgId1 = await createOrganization(orgName1, 'icon.png', 'desc', testUser.id);
        assert.ok(orgId1, 'Organization should be created');
        
        const events = await getOrganizationEvents(orgId1);
        assert.strictEqual(Array.isArray(events), true);
        assert.strictEqual(events.length, 0);
    });

    test('addUserToOrganization should add user with role', async () => {
        // Create new test user and organization
        const newUserId = await userModule.createUser(
            'Test Member',
            `member${timestamp}@example.com`,
            'password123'
        );
        const newUser = await userModule.getUser(newUserId);
        assert.ok(newUser, 'New test user should be created');
        
        const orgId2 = await createOrganization('Member Test Org', 'icon.png', 'desc', testUser.id);
        assert.ok(orgId2, 'Organization should be created');
        
        // Add new user to organization
        const result = await addUserToOrganization(orgId2, newUser.id, ownerRole.id);
        assert.strictEqual(result, true);
    });

    test('addUserToOrganization should reject invalid user', async () => {
        const orgName3 = 'Test Org Invalid User';
        const orgId3 = await createOrganization(orgName3, 'icon.png', 'desc', testUser.id);
        assert.ok(orgId3, 'Organization should be created');
        
        await assert.rejects(
            async () => {
                await addUserToOrganization(orgId3, 99999, ownerRole.id);
            },
            error => {
                assert.ok(error.message.includes('User 99999 not found'));
                return true;
            }
        );
    });

    test('addUserToOrganization should reject invalid organization', async () => {
        await assert.rejects(
            async () => {
                await addUserToOrganization(99999, testUser.id, ownerRole.id);
            },
            error => {
                assert.ok(error.message.includes('Organization 99999 not found'));
                return true;
            }
        );
    });

    test('getOrganizationUsers should return organization members', async () => {
        // Create a new organization with the test user as owner
        const orgName4 = 'Test Org Members';
        const orgId4 = await createOrganization(orgName4, 'icon.png', 'desc', testUser.id);
        assert.ok(orgId4, 'Organization should be created');
        
        // Create another test user
        const memberId = await userModule.createUser(
            'Test Member 2',
            `member2_${timestamp}@example.com`,
            'password123'
        );
        const memberUser = await userModule.getUser(memberId);
        assert.ok(memberUser, 'Member user should be created');
        
        // Add the new user to the organization
        const addResult = await addUserToOrganization(orgId4, memberUser.id, ownerRole.id);
        assert.strictEqual(addResult, true, 'User should be added to organization');
        
        // Get organization users
        const users = await getOrganizationUsers(orgId4);
        
        // Verify the response
        assert.strictEqual(Array.isArray(users), true);
        assert.strictEqual(users.length >= 1, true, 'Should have at least one user');
        
        // Verify user objects have correct properties
        const user = users[0];
        assert.ok(user.id, 'User should have id');
        assert.ok(user.name, 'User should have name');
        assert.ok(user.email, 'User should have email');
        assert.ok('is_admin' in user, 'User should have is_admin property');
        assert.ok('role' in user, 'User should have role property');
    });
});